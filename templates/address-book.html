{% extends 'base.html' %}
{% load static %}
{% load contact_tags %}
{% block content %}
    <div class="wrapper">
        <main class="address-book-container">
            <div class="address-book-header">
                <h1>Your Address Book</h1>
                <div class="actions">
                    <div class="search-bar-sorting">
                        <input type="text" placeholder="Search contacts..." id="search-bar">

                        <!-- Dropdown for sorting contacts -->
                        <select id="sort-options" class="sort-dropdown">
                            <option value="a-z">Sort: A-Z</option>
                            <option value="z-a">Sort: Z-A</option>
                        </select>

                        <!-- Dropdown for filtering contacts by labels -->
                        <select id="filter-options" class="sort-dropdown">
                            <option value="all">All</option>
                            {% for label in user_labels %}
                                <option value="{{ label }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <a href="{% url 'create-contact' %}" class="add-contact-btn">+ Add Contact</a>
                </div>
            </div>

            <div id="contacts-container">
                {% include 'contacts/container-contacts.html' %}
            </div>

            <div id="paginator-container">
                {% include 'common/paginator.html' %}
            </div>
        </main>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/ajax-pagination.js' %}"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const searchInput = document.getElementById("search-bar");
            const categoryFilter = document.getElementById("filter-options");
            const sortOptions = document.getElementById("sort-options");
            const contactList = document.querySelector(".contact-list");
            const contactItems = Array.from(document.querySelectorAll(".contact-item"));

            // Function to filter contacts based on search term and selected category
            function filterContacts() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedCategory = categoryFilter.value.toLowerCase();

                contactItems.forEach(item => {
                    const card = item.querySelector(".contact-card");
                    const title = card.querySelector("h2").textContent.toLowerCase();
                    const labels = card.querySelectorAll(".book-label");

                    // Extract all labels from the contact and check if they match the filter
                    let categories = [];
                    labels.forEach(label => {
                        categories.push(label.textContent.toLowerCase());
                    });

                    const matchesSearch = title.includes(searchTerm);
                    const matchesCategory = selectedCategory === "all" || categories.includes(selectedCategory);

                    if (matchesSearch && matchesCategory) {
                        item.style.display = "block";
                    } else {
                        item.style.display = "none";
                    }
                });
            }

            // Function to sort contacts based on the selected sort option (A-Z or Z-A)
            function sortContacts() {
                const sortOption = sortOptions.value;

                contactItems.sort((a, b) => {
                    const nameA = a.querySelector("h2").textContent.toLowerCase();
                    const nameB = b.querySelector("h2").textContent.toLowerCase();

                    if (sortOption === "a-z") {
                        return nameA.localeCompare(nameB);
                    } else if (sortOption === "z-a") {
                        return nameB.localeCompare(nameA);
                    }
                    return 0;
                });

                contactItems.forEach(item => {
                    contactList.appendChild(item);
                });
            }

            searchInput.addEventListener("input", () => {
                filterContacts();
            });

            categoryFilter.addEventListener("change", () => {
                filterContacts();
            });

            sortOptions.addEventListener("change", () => {
                sortContacts();
                filterContacts();
            });

            sortContacts();
            filterContacts();
        });
    </script>
{% endblock %}
