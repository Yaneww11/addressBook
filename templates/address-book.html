{% extends 'base.html' %}
{% load contact_tags %}
{% block content %}
    <div class="wrapper">
        <main class="address-book-container">
            <div class="address-book-header">
                <h1>Your Address Book</h1>
                <div class="actions">
                    <div class="search-bar-sorting">
                        <input type="text" placeholder="Search contacts..." id="search-bar">
                        <select id="sort-options" class="sort-dropdown">
                            <option value="a-z">Sort: A-Z</option>
                            <option value="z-a">Sort: Z-A</option>
                        </select>
                        <select id="filter-options" class="sort-dropdown">
                            <option value="all">All</option>
                            {% for label in user_labels %}
                                <option value="{{ label }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <a href="{% url 'create-contact' %}" class="add-contact-btn">+ Add Contact</a>

                </div>
            </div>
            <ul class="contact-list">
                {% for contact in contacts %}
                    <li class="contact-item">
                        <a href="{% url 'detail-contact' pk=contact.pk %}">
                            <div class="contact-card">
                                <div class="contact-left">
                                    <img src="{{ contact.image.url }}" alt="Contact Picture" class="contact-picture">
                                    <div class="contact-name-labels">
                                        <h2>{{ contact }}</h2>
                                        <!-- TODO or remove: if contact has labels display this block -->
                                        <div class="book-labels">
                                            {% get_contact_labels contact as con_labels %}
                                            {% if con_labels.count > 2 %}
                                                <span class="book-label"
                                                      style="background-color: {{ con_labels.first.color }};">{{ con_labels.first }}</span>
                                                <span class="book-label"
                                                      style="background-color: #646464;"> +{{ con_labels.count|add:"-1" }} more labels</span>
                                            {% else %}
                                                {% for label in con_labels %}
                                                    <span class="book-label"
                                                          style="background-color: {{ label.color }};">{{ label }}</span>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <p class="contact-phone">{{ contact.phone_number }}</p>
                            </div>
                        </a>
                    </li>
                {% endfor %}
            </ul>

            <!-- Not works good with search js, may remove-->
            {#            {% include 'common/paginator.html' %}#}
        </main>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const searchInput = document.getElementById("search-bar");
            const categoryFilter = document.getElementById("filter-options");
            const sortOptions = document.getElementById("sort-options");
            const contactList = document.querySelector(".contact-list");
            const contactItems = Array.from(document.querySelectorAll(".contact-item"));

            // Function to filter contacts using search string and category
            function filterContacts() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedCategory = categoryFilter.value.toLowerCase();

                contactItems.forEach(item => {
                    const card = item.querySelector(".contact-card");
                    const title = card.querySelector("h2").textContent.toLowerCase();
                    const labels = card.querySelectorAll(".book-label");

                    // Get categories
                    let categories = [];
                    labels.forEach(label => {
                        categories.push(label.textContent.toLowerCase());
                    });

                    // Check if the card matches the search term and category
                    const matchesSearch = title.includes(searchTerm);
                    const matchesCategory = selectedCategory === "all" || categories.includes(selectedCategory);

                    if (matchesSearch && matchesCategory) {
                        item.style.display = "block";
                    } else {
                        item.style.display = "none";
                    }
                });
            }

            // Function to sort contacts from selected option in dropdown
            function sortContacts() {
                const sortOption = sortOptions.value;

                // Sort contactItems array based on the selected sort option
                contactItems.sort((a, b) => {
                    const nameA = a.querySelector("h2").textContent.toLowerCase();
                    const nameB = b.querySelector("h2").textContent.toLowerCase();

                    if (sortOption === "a-z") {
                        return nameA.localeCompare(nameB);
                    } else if (sortOption === "z-a") {
                        return nameB.localeCompare(nameA);
                    }
                    return 0;
                });

                // Reorder the items in the contact list
                contactItems.forEach(item => {
                    contactList.appendChild(item);
                });
            }

            // Add event listeners
            searchInput.addEventListener("input", () => {
                filterContacts();
            });

            categoryFilter.addEventListener("change", () => {
                filterContacts();
            });

            sortOptions.addEventListener("change", () => {
                sortContacts();
                filterContacts(); // Reapply filters after sorting
            });

            // Initial render
            sortContacts();
            filterContacts();
        });
    </script>
{% endblock %}